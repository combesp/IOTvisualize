<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Data Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            color: #fff;
            background: url('https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=1950&q=80') no-repeat center center fixed;
            background-size: cover;
        }
        .overlay {
            background: rgba(0, 0, 0, 0.6);
            min-height: 100vh;
            padding: 2rem;
        }
        h1 {
            text-align: center;
            margin-top: 0;
        }
        #chart-container {
            width: 80%;
            margin: 2rem auto;
        }
        #time-slider {
            width: 80%;
            margin: 1rem auto;
            display: block;
        }
        #data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
            background-color: rgba(255,255,255,0.1);
        }
        #data-table th, #data-table td {
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255,255,255,0.2);
            text-align: center;
        }
        #data-table th {
            background-color: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div class="overlay">
        <h1>Sensor Data</h1>
        <div id="chart-container">
            <canvas id="sensor-chart"></canvas>
        </div>
        <input type="range" id="time-slider" min="0" value="0" step="1" />
        <table id="data-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Temperature (&deg;C)</th>
                    <th>Humidity (%)</th>
                    <th>Pressure</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const dataTable = document.getElementById('data-table');
        const dataTableBody = dataTable.getElementsByTagName('tbody')[0];
        const ctx = document.getElementById('sensor-chart').getContext('2d');
        const timeSlider = document.getElementById('time-slider');

        const WINDOW_SIZE = 20;
        let labels = [];
        let temps = [];
        let hums = [];
        let presses = [];

        const sensorChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Temperature (Â°C)',
                        data: [],
                        borderColor: '#ff6384',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Humidity (%)',
                        data: [],
                        borderColor: '#36a2eb',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Pressure',
                        data: [],
                        borderColor: '#ffce56',
                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    zoom: {
                        pan: { enabled: true, mode: 'x' },
                        zoom: {
                            wheel: { enabled: true },
                            pinch: { enabled: true },
                            mode: 'x'
                        }
                    }
                },
                scales: {
                    x: { display: true },
                    y: { type: 'linear', position: 'left' },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });

        function updateChart(startIndex) {
            const end = startIndex + WINDOW_SIZE;
            sensorChart.data.labels = labels.slice(startIndex, end);
            sensorChart.data.datasets[0].data = temps.slice(startIndex, end);
            sensorChart.data.datasets[1].data = hums.slice(startIndex, end);
            sensorChart.data.datasets[2].data = presses.slice(startIndex, end);
            sensorChart.update();
        }

        timeSlider.addEventListener('input', () => {
            updateChart(parseInt(timeSlider.value, 10));
        });

        function loadData() {
            dataTableBody.innerHTML = '';

            axios.get('https://getrecentsensordata-192354701158.europe-west9.run.app')
                .then(function (data) {
                    labels = [];
                    temps = [];
                    hums = [];
                    presses = [];

                    const readings = data.data;

                    for (const reading of readings) {
                        const ts = new Date(reading.timestamp);
                        labels.push(ts.toLocaleTimeString('en-GB'));
                        temps.push(reading.temperature.toFixed(1));
                        hums.push(reading.humidity.toFixed(0));
                        presses.push(reading.pressure.toFixed(1));
                    }

                    const recentReadings = readings.slice(-10);
                    for (const reading of recentReadings) {
                        const row = document.createElement('tr');

                        const timeCell = document.createElement('td');
                        const ts = new Date(reading.timestamp);
                        timeCell.innerText = ts.toLocaleString('en-GB');
                        row.appendChild(timeCell);

                        const tempCell = document.createElement('td');
                        const temp = reading.temperature.toFixed(1);
                        tempCell.innerHTML = temp + ' &deg;C';
                        row.appendChild(tempCell);

                        const humCell = document.createElement('td');
                        const hum = reading.humidity.toFixed(0);
                        humCell.innerText = hum + ' %';
                        row.appendChild(humCell);

                        const presCell = document.createElement('td');
                        const pres = reading.pressure.toFixed(1);
                        presCell.innerText = pres;
                        row.appendChild(presCell);

                        dataTableBody.appendChild(row);
                    }

                    const maxSlider = Math.max(0, labels.length - WINDOW_SIZE);
                    timeSlider.max = maxSlider;
                    timeSlider.value = maxSlider;
                    updateChart(parseInt(timeSlider.value, 10));
                });
        }

        loadData();
    </script>
</body>
</html>
